
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Python library for mechanistic interpretability research on Large Language Models">
      
      
      
        <link rel="canonical" href="https://adamkaniasty.github.io/Inzynierka/api/sae/">
      
      
        <link rel="prev" href="../language_model/">
      
      
        <link rel="next" href="../datasets/">
      
      
        
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>SAE - Mi-Crow</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#sparse-autoencoder-sae-api" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Mi-Crow" class="md-header__button md-logo" aria-label="Mi-Crow" data-md-component="logo">
      
  <img src="../../docs/logo.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Mi-Crow
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              SAE
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/AdamKaniasty/Inzynierka" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    AdamKaniasty/Inzynierka
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../guide/" class="md-tabs__link">
        
  
  
    
  
  User Guide

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../experiments/" class="md-tabs__link">
        
  
  
    
  
  Experiments

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    <li class="md-tabs__item md-tabs__item--active">
      <a href="../" class="md-tabs__link">
        
  
  
    
  
  API Reference

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Mi-Crow" class="md-nav__button md-logo" aria-label="Mi-Crow" data-md-component="logo">
      
  <img src="../../docs/logo.svg" alt="logo">

    </a>
    Mi-Crow
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/AdamKaniasty/Inzynierka" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    AdamKaniasty/Inzynierka
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../guide/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    User Guide
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2" id="__nav_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    User Guide
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Installation &amp; Setup
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/quickstart/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Quick Start
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/core-concepts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Core Concepts
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../guide/hooks/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Hooks System
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_4" id="__nav_2_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Hooks System
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/hooks/fundamentals/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Hooks Fundamentals
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/hooks/detectors/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Using Detector Hooks
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/hooks/controllers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Using Controller Hooks
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/hooks/registration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Hook Registration and Management
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/hooks/advanced/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Advanced Hooks Patterns
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_5" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../guide/workflows/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Workflows
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_5" id="__nav_2_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Workflows
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/workflows/saving-activations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Saving Activations
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/workflows/training-sae/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Training SAE Models
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/workflows/concept-discovery/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Concept Discovery
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/workflows/concept-manipulation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Concept Manipulation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/workflows/activation-control/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Activation Control with Hooks
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/best-practices/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Best Practices
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/troubleshooting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Troubleshooting
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/examples/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Examples
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../experiments/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Experiments
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3" id="__nav_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Experiments
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../experiments/verify-sae-training/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Verify SAE Training Experiment
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../experiments/slurm-pipeline/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SLURM SAE Pipeline
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    API Reference
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4" id="__nav_4_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    API Reference
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    API Reference
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../language_model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Language Model
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    SAE
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    SAE
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#core-sae-classes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Core SAE Classes
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.sae.Sae" class="md-nav__link">
    <span class="md-ellipsis">
      
        Sae
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Sae">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.sae.Sae.context" class="md-nav__link">
    <span class="md-ellipsis">
      
        context
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.sae.Sae.process_activations" class="md-nav__link">
    <span class="md-ellipsis">
      
        process_activations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.sae.Sae.set_context" class="md-nav__link">
    <span class="md-ellipsis">
      
        set_context
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.modules.topk_sae.TopKSae" class="md-nav__link">
    <span class="md-ellipsis">
      
        TopKSae
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="TopKSae">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.modules.topk_sae.TopKSae.decode" class="md-nav__link">
    <span class="md-ellipsis">
      
        decode
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.modules.topk_sae.TopKSae.encode" class="md-nav__link">
    <span class="md-ellipsis">
      
        encode
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.modules.topk_sae.TopKSae.forward" class="md-nav__link">
    <span class="md-ellipsis">
      
        forward
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.modules.topk_sae.TopKSae.load" class="md-nav__link">
    <span class="md-ellipsis">
      
        load
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.modules.topk_sae.TopKSae.modify_activations" class="md-nav__link">
    <span class="md-ellipsis">
      
        modify_activations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.modules.topk_sae.TopKSae.process_activations" class="md-nav__link">
    <span class="md-ellipsis">
      
        process_activations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.modules.topk_sae.TopKSae.save" class="md-nav__link">
    <span class="md-ellipsis">
      
        save
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.modules.topk_sae.TopKSae.train" class="md-nav__link">
    <span class="md-ellipsis">
      
        train
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.autoencoder_context.AutoencoderContext" class="md-nav__link">
    <span class="md-ellipsis">
      
        AutoencoderContext
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#training" class="md-nav__link">
    <span class="md-ellipsis">
      
        Training
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.sae_trainer.SaeTrainer" class="md-nav__link">
    <span class="md-ellipsis">
      
        SaeTrainer
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.sae_trainer.SaeTrainingConfig" class="md-nav__link">
    <span class="md-ellipsis">
      
        SaeTrainingConfig
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.modules.topk_sae.TopKSaeTrainingConfig" class="md-nav__link">
    <span class="md-ellipsis">
      
        TopKSaeTrainingConfig
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#concepts" class="md-nav__link">
    <span class="md-ellipsis">
      
        Concepts
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.concepts.autoencoder_concepts.AutoencoderConcepts" class="md-nav__link">
    <span class="md-ellipsis">
      
        AutoencoderConcepts
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AutoencoderConcepts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.concepts.autoencoder_concepts.AutoencoderConcepts.enable_text_tracking" class="md-nav__link">
    <span class="md-ellipsis">
      
        enable_text_tracking
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.concepts.autoencoder_concepts.AutoencoderConcepts.export_bottom_texts_to_json" class="md-nav__link">
    <span class="md-ellipsis">
      
        export_bottom_texts_to_json
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.concepts.autoencoder_concepts.AutoencoderConcepts.export_top_texts_to_json" class="md-nav__link">
    <span class="md-ellipsis">
      
        export_top_texts_to_json
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.concepts.autoencoder_concepts.AutoencoderConcepts.generate_concepts_with_llm" class="md-nav__link">
    <span class="md-ellipsis">
      
        generate_concepts_with_llm
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.concepts.autoencoder_concepts.AutoencoderConcepts.get_all_bottom_texts" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_all_bottom_texts
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.concepts.autoencoder_concepts.AutoencoderConcepts.get_all_top_texts" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_all_top_texts
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.concepts.autoencoder_concepts.AutoencoderConcepts.get_bottom_texts_for_neuron" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_bottom_texts_for_neuron
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.concepts.autoencoder_concepts.AutoencoderConcepts.get_top_texts_for_neuron" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_top_texts_for_neuron
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.concepts.autoencoder_concepts.AutoencoderConcepts.reset_top_texts" class="md-nav__link">
    <span class="md-ellipsis">
      
        reset_top_texts
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.concepts.autoencoder_concepts.AutoencoderConcepts.update_top_texts_from_latents" class="md-nav__link">
    <span class="md-ellipsis">
      
        update_top_texts_from_latents
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.concepts.concept_dictionary.ConceptDictionary" class="md-nav__link">
    <span class="md-ellipsis">
      
        ConceptDictionary
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.concepts.concept_models" class="md-nav__link">
    <span class="md-ellipsis">
      
        concept_models
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.concepts.input_tracker.InputTracker" class="md-nav__link">
    <span class="md-ellipsis">
      
        InputTracker
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="InputTracker">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.concepts.input_tracker.InputTracker.enabled" class="md-nav__link">
    <span class="md-ellipsis">
      
        enabled
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.concepts.input_tracker.InputTracker.disable" class="md-nav__link">
    <span class="md-ellipsis">
      
        disable
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.concepts.input_tracker.InputTracker.enable" class="md-nav__link">
    <span class="md-ellipsis">
      
        enable
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.concepts.input_tracker.InputTracker.get_current_texts" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_current_texts
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.concepts.input_tracker.InputTracker.reset" class="md-nav__link">
    <span class="md-ellipsis">
      
        reset
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.concepts.input_tracker.InputTracker.set_current_texts" class="md-nav__link">
    <span class="md-ellipsis">
      
        set_current_texts
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#training-utilities" class="md-nav__link">
    <span class="md-ellipsis">
      
        Training Utilities
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.training.wandb_logger.WandbLogger" class="md-nav__link">
    <span class="md-ellipsis">
      
        WandbLogger
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="WandbLogger">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.training.wandb_logger.WandbLogger.initialize" class="md-nav__link">
    <span class="md-ellipsis">
      
        initialize
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.training.wandb_logger.WandbLogger.log_metrics" class="md-nav__link">
    <span class="md-ellipsis">
      
        log_metrics
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../datasets/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Datasets
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../store/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Store
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hooks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Hooks
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#core-sae-classes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Core SAE Classes
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.sae.Sae" class="md-nav__link">
    <span class="md-ellipsis">
      
        Sae
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Sae">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.sae.Sae.context" class="md-nav__link">
    <span class="md-ellipsis">
      
        context
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.sae.Sae.process_activations" class="md-nav__link">
    <span class="md-ellipsis">
      
        process_activations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.sae.Sae.set_context" class="md-nav__link">
    <span class="md-ellipsis">
      
        set_context
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.modules.topk_sae.TopKSae" class="md-nav__link">
    <span class="md-ellipsis">
      
        TopKSae
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="TopKSae">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.modules.topk_sae.TopKSae.decode" class="md-nav__link">
    <span class="md-ellipsis">
      
        decode
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.modules.topk_sae.TopKSae.encode" class="md-nav__link">
    <span class="md-ellipsis">
      
        encode
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.modules.topk_sae.TopKSae.forward" class="md-nav__link">
    <span class="md-ellipsis">
      
        forward
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.modules.topk_sae.TopKSae.load" class="md-nav__link">
    <span class="md-ellipsis">
      
        load
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.modules.topk_sae.TopKSae.modify_activations" class="md-nav__link">
    <span class="md-ellipsis">
      
        modify_activations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.modules.topk_sae.TopKSae.process_activations" class="md-nav__link">
    <span class="md-ellipsis">
      
        process_activations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.modules.topk_sae.TopKSae.save" class="md-nav__link">
    <span class="md-ellipsis">
      
        save
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.modules.topk_sae.TopKSae.train" class="md-nav__link">
    <span class="md-ellipsis">
      
        train
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.autoencoder_context.AutoencoderContext" class="md-nav__link">
    <span class="md-ellipsis">
      
        AutoencoderContext
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#training" class="md-nav__link">
    <span class="md-ellipsis">
      
        Training
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.sae_trainer.SaeTrainer" class="md-nav__link">
    <span class="md-ellipsis">
      
        SaeTrainer
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.sae_trainer.SaeTrainingConfig" class="md-nav__link">
    <span class="md-ellipsis">
      
        SaeTrainingConfig
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.modules.topk_sae.TopKSaeTrainingConfig" class="md-nav__link">
    <span class="md-ellipsis">
      
        TopKSaeTrainingConfig
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#concepts" class="md-nav__link">
    <span class="md-ellipsis">
      
        Concepts
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.concepts.autoencoder_concepts.AutoencoderConcepts" class="md-nav__link">
    <span class="md-ellipsis">
      
        AutoencoderConcepts
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AutoencoderConcepts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.concepts.autoencoder_concepts.AutoencoderConcepts.enable_text_tracking" class="md-nav__link">
    <span class="md-ellipsis">
      
        enable_text_tracking
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.concepts.autoencoder_concepts.AutoencoderConcepts.export_bottom_texts_to_json" class="md-nav__link">
    <span class="md-ellipsis">
      
        export_bottom_texts_to_json
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.concepts.autoencoder_concepts.AutoencoderConcepts.export_top_texts_to_json" class="md-nav__link">
    <span class="md-ellipsis">
      
        export_top_texts_to_json
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.concepts.autoencoder_concepts.AutoencoderConcepts.generate_concepts_with_llm" class="md-nav__link">
    <span class="md-ellipsis">
      
        generate_concepts_with_llm
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.concepts.autoencoder_concepts.AutoencoderConcepts.get_all_bottom_texts" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_all_bottom_texts
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.concepts.autoencoder_concepts.AutoencoderConcepts.get_all_top_texts" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_all_top_texts
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.concepts.autoencoder_concepts.AutoencoderConcepts.get_bottom_texts_for_neuron" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_bottom_texts_for_neuron
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.concepts.autoencoder_concepts.AutoencoderConcepts.get_top_texts_for_neuron" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_top_texts_for_neuron
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.concepts.autoencoder_concepts.AutoencoderConcepts.reset_top_texts" class="md-nav__link">
    <span class="md-ellipsis">
      
        reset_top_texts
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.concepts.autoencoder_concepts.AutoencoderConcepts.update_top_texts_from_latents" class="md-nav__link">
    <span class="md-ellipsis">
      
        update_top_texts_from_latents
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.concepts.concept_dictionary.ConceptDictionary" class="md-nav__link">
    <span class="md-ellipsis">
      
        ConceptDictionary
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.concepts.concept_models" class="md-nav__link">
    <span class="md-ellipsis">
      
        concept_models
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.concepts.input_tracker.InputTracker" class="md-nav__link">
    <span class="md-ellipsis">
      
        InputTracker
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="InputTracker">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.concepts.input_tracker.InputTracker.enabled" class="md-nav__link">
    <span class="md-ellipsis">
      
        enabled
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.concepts.input_tracker.InputTracker.disable" class="md-nav__link">
    <span class="md-ellipsis">
      
        disable
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.concepts.input_tracker.InputTracker.enable" class="md-nav__link">
    <span class="md-ellipsis">
      
        enable
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.concepts.input_tracker.InputTracker.get_current_texts" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_current_texts
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.concepts.input_tracker.InputTracker.reset" class="md-nav__link">
    <span class="md-ellipsis">
      
        reset
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.concepts.input_tracker.InputTracker.set_current_texts" class="md-nav__link">
    <span class="md-ellipsis">
      
        set_current_texts
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#training-utilities" class="md-nav__link">
    <span class="md-ellipsis">
      
        Training Utilities
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.training.wandb_logger.WandbLogger" class="md-nav__link">
    <span class="md-ellipsis">
      
        WandbLogger
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="WandbLogger">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.training.wandb_logger.WandbLogger.initialize" class="md-nav__link">
    <span class="md-ellipsis">
      
        initialize
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mi_crow.mechanistic.sae.training.wandb_logger.WandbLogger.log_metrics" class="md-nav__link">
    <span class="md-ellipsis">
      
        log_metrics
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
    <a href="https://github.com/AdamKaniasty/Inzynierka/blob/main/api/sae.md" title="Edit this page" class="md-content__button md-icon" rel="edit">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  


<h1 id="sparse-autoencoder-sae-api">Sparse Autoencoder (SAE) API<a class="headerlink" href="#sparse-autoencoder-sae-api" title="Permanent link">&para;</a></h1>
<p>Sparse Autoencoders, training, concepts, and related modules for mechanistic interpretability.</p>
<h2 id="core-sae-classes">Core SAE Classes<a class="headerlink" href="#core-sae-classes" title="Permanent link">&para;</a></h2>


<div class="doc doc-object doc-class">



<h2 id="mi_crow.mechanistic.sae.sae.Sae" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">mi_crow.mechanistic.sae.sae.Sae</span>


<a href="#mi_crow.mechanistic.sae.sae.Sae" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">Sae</span><span class="p">(</span><span class="n">n_latents</span><span class="p">,</span> <span class="n">n_inputs</span><span class="p">,</span> <span class="n">hook_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="&lt;span class=&quot;doc doc-object-name doc-class-name&quot;&gt;mi_crow.hooks.controller.Controller&lt;/span&gt;" href="../hooks/#mi_crow.hooks.controller.Controller">Controller</a></code>, <code><a class="autorefs autorefs-internal" title="&lt;span class=&quot;doc doc-object-name doc-class-name&quot;&gt;mi_crow.hooks.detector.Detector&lt;/span&gt;" href="../hooks/#mi_crow.hooks.detector.Detector">Detector</a></code>, <code><span title="abc.ABC">ABC</span></code></p>










                  <details class="mkdocstrings-source">
                    <summary>Source code in <code>src/mi_crow/mechanistic/sae/sae.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">n_latents</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">n_inputs</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">hook_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;cpu&#39;</span><span class="p">,</span>
        <span class="n">store</span><span class="p">:</span> <span class="n">Store</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1"># Initialize both Controller and Detector</span>
    <span class="n">Controller</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hook_type</span><span class="o">=</span><span class="n">HookType</span><span class="o">.</span><span class="n">FORWARD</span><span class="p">,</span> <span class="n">hook_id</span><span class="o">=</span><span class="n">hook_id</span><span class="p">)</span>
    <span class="n">Detector</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hook_type</span><span class="o">=</span><span class="n">HookType</span><span class="o">.</span><span class="n">FORWARD</span><span class="p">,</span> <span class="n">hook_id</span><span class="o">=</span><span class="n">hook_id</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="n">store</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_autoencoder_context</span> <span class="o">=</span> <span class="n">AutoencoderContext</span><span class="p">(</span>
        <span class="n">autoencoder</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">n_latents</span><span class="o">=</span><span class="n">n_latents</span><span class="p">,</span>
        <span class="n">n_inputs</span><span class="o">=</span><span class="n">n_inputs</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_autoencoder_context</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sae_engine</span><span class="p">:</span> <span class="n">OvercompleteSAE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_sae_engine</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">concepts</span> <span class="o">=</span> <span class="n">AutoencoderConcepts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_autoencoder_context</span><span class="p">)</span>

    <span class="c1"># Text tracking flag</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_text_tracking_enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Training component</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span> <span class="o">=</span> <span class="n">SaeTrainer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
                  </details>



<div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="mi_crow.mechanistic.sae.sae.Sae.context" class="doc doc-heading">
            <span class="doc doc-object-name doc-attribute-name">context</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
      <small class="doc doc-label doc-label-writable"><code>writable</code></small>
  </span>

<a href="#mi_crow.mechanistic.sae.sae.Sae.context" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">context</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Get the AutoencoderContext associated with this SAE.</p>

    </div>

</div>




<div class="doc doc-object doc-function">


<h3 id="mi_crow.mechanistic.sae.sae.Sae.process_activations" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">process_activations</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

<a href="#mi_crow.mechanistic.sae.sae.Sae.process_activations" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">process_activations</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Process activations to save neuron activations in metadata.</p>
<p>This implements the Detector interface. It extracts activations, encodes them
to get neuron activations (latents), and saves metadata for each item in the batch
individually, including nonzero latent indices and activations.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>module</code>
            </td>
            <td>
                  <code><span title="torch.nn.Module">Module</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The PyTorch module being hooked</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>input</code>
            </td>
            <td>
                  <code><span title="mi_crow.hooks.hook.HOOK_FUNCTION_INPUT">HOOK_FUNCTION_INPUT</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tuple of input tensors to the module</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output</code>
            </td>
            <td>
                  <code><span title="mi_crow.hooks.hook.HOOK_FUNCTION_OUTPUT">HOOK_FUNCTION_OUTPUT</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Output tensor(s) from the module</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/mi_crow/mechanistic/sae/sae.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">process_activations</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">module</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span>
        <span class="nb">input</span><span class="p">:</span> <span class="n">HOOK_FUNCTION_INPUT</span><span class="p">,</span>
        <span class="n">output</span><span class="p">:</span> <span class="n">HOOK_FUNCTION_OUTPUT</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process activations to save neuron activations in metadata.</span>

<span class="sd">    This implements the Detector interface. It extracts activations, encodes them</span>
<span class="sd">    to get neuron activations (latents), and saves metadata for each item in the batch</span>
<span class="sd">    individually, including nonzero latent indices and activations.</span>

<span class="sd">    Args:</span>
<span class="sd">        module: The PyTorch module being hooked</span>
<span class="sd">        input: Tuple of input tensors to the module</span>
<span class="sd">        output: Output tensor(s) from the module</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;process_activations method not implemented.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="mi_crow.mechanistic.sae.sae.Sae.set_context" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">set_context</span>


<a href="#mi_crow.mechanistic.sae.sae.Sae.set_context" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">set_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Set the LanguageModelContext for this hook and sync to AutoencoderContext.</p>
<p>When the hook is registered, this method is called with the LanguageModelContext.
It automatically syncs relevant values to the AutoencoderContext, including device.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>context</code>
            </td>
            <td>
                  <code><span title="LanguageModelContext">LanguageModelContext</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The LanguageModelContext instance from the LanguageModel</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/mi_crow/mechanistic/sae/sae.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="s2">&quot;LanguageModelContext&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set the LanguageModelContext for this hook and sync to AutoencoderContext.</span>

<span class="sd">    When the hook is registered, this method is called with the LanguageModelContext.</span>
<span class="sd">    It automatically syncs relevant values to the AutoencoderContext, including device.</span>

<span class="sd">    Args:</span>
<span class="sd">        context: The LanguageModelContext instance from the LanguageModel</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Hook</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_context</span> <span class="o">=</span> <span class="n">context</span>
    <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_autoencoder_context</span><span class="o">.</span><span class="n">lm</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">language_model</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">model_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_autoencoder_context</span><span class="o">.</span><span class="n">model_id</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">model_id</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">store</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_autoencoder_context</span><span class="o">.</span><span class="n">store</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_autoencoder_context</span><span class="o">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">store</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_signature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_autoencoder_context</span><span class="o">.</span><span class="n">lm_layer_signature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_signature</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">device</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_autoencoder_context</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">device</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="mi_crow.mechanistic.sae.modules.topk_sae.TopKSae" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">mi_crow.mechanistic.sae.modules.topk_sae.TopKSae</span>


<a href="#mi_crow.mechanistic.sae.modules.topk_sae.TopKSae" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">TopKSae</span><span class="p">(</span><span class="n">n_latents</span><span class="p">,</span> <span class="n">n_inputs</span><span class="p">,</span> <span class="n">hook_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="&lt;span class=&quot;doc doc-object-name doc-class-name&quot;&gt;mi_crow.mechanistic.sae.sae.Sae&lt;/span&gt;" href="#mi_crow.mechanistic.sae.sae.Sae">Sae</a></code></p>



        <p>Initialize TopK SAE.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>n_latents</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of latent dimensions (concepts)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_inputs</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of input dimensions</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>hook_id</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional hook identifier</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>device</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Device to run on ('cpu', 'cuda', 'mps')</p>
              </div>
            </td>
            <td>
                  <code>&#39;cpu&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>store</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="&lt;span class=&quot;doc doc-object-name doc-class-name&quot;&gt;Store&lt;/span&gt; (&lt;code&gt;mi_crow.store.store.Store&lt;/code&gt;)" href="../store/#mi_crow.store.Store">Store</a> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional store instance</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Note</summary>
  <p>The <code>k</code> parameter must be provided in TopKSaeTrainingConfig during training.
For loaded models, <code>k</code> is restored from saved metadata.
A temporary default k=1 is used for engine initialization and will be
overridden with the actual k value from config during training.</p>
</details>







                  <details class="mkdocstrings-source">
                    <summary>Source code in <code>src/mi_crow/mechanistic/sae/modules/topk_sae.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">n_latents</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">n_inputs</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">hook_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;cpu&#39;</span><span class="p">,</span>
        <span class="n">store</span><span class="p">:</span> <span class="n">Store</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize TopK SAE.</span>

<span class="sd">    Args:</span>
<span class="sd">        n_latents: Number of latent dimensions (concepts)</span>
<span class="sd">        n_inputs: Number of input dimensions</span>
<span class="sd">        hook_id: Optional hook identifier</span>
<span class="sd">        device: Device to run on (&#39;cpu&#39;, &#39;cuda&#39;, &#39;mps&#39;)</span>
<span class="sd">        store: Optional store instance</span>

<span class="sd">    Note:</span>
<span class="sd">        The `k` parameter must be provided in TopKSaeTrainingConfig during training.</span>
<span class="sd">        For loaded models, `k` is restored from saved metadata.</span>
<span class="sd">        A temporary default k=1 is used for engine initialization and will be</span>
<span class="sd">        overridden with the actual k value from config during training.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">n_latents</span><span class="p">,</span> <span class="n">n_inputs</span><span class="p">,</span> <span class="n">hook_id</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">store</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
                  </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="mi_crow.mechanistic.sae.modules.topk_sae.TopKSae.decode" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">decode</span>


<a href="#mi_crow.mechanistic.sae.modules.topk_sae.TopKSae.decode" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">decode</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Decode latents using sae_engine.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>x</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Encoded tensor of shape [batch_size, n_latents]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Reconstructed tensor of shape [batch_size, n_inputs]</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/mi_crow/mechanistic/sae/modules/topk_sae.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decode latents using sae_engine.</span>

<span class="sd">    Args:</span>
<span class="sd">        x: Encoded tensor of shape [batch_size, n_latents]</span>

<span class="sd">    Returns:</span>
<span class="sd">        Reconstructed tensor of shape [batch_size, n_inputs]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sae_engine</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="mi_crow.mechanistic.sae.modules.topk_sae.TopKSae.encode" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">encode</span>


<a href="#mi_crow.mechanistic.sae.modules.topk_sae.TopKSae.encode" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">encode</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Encode input using sae_engine.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>x</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input tensor of shape [batch_size, n_inputs]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Encoded latents (TopK sparse activations)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/mi_crow/mechanistic/sae/modules/topk_sae.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Encode input using sae_engine.</span>

<span class="sd">    Args:</span>
<span class="sd">        x: Input tensor of shape [batch_size, n_inputs]</span>

<span class="sd">    Returns:</span>
<span class="sd">        Encoded latents (TopK sparse activations)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Overcomplete TopKSAE encode returns (pre_codes, codes)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">codes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sae_engine</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">codes</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="mi_crow.mechanistic.sae.modules.topk_sae.TopKSae.forward" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">forward</span>


<a href="#mi_crow.mechanistic.sae.modules.topk_sae.TopKSae.forward" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">forward</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Forward pass using sae_engine.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>x</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input tensor of shape [batch_size, n_inputs]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Reconstructed tensor of shape [batch_size, n_inputs]</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/mi_crow/mechanistic/sae/modules/topk_sae.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Forward pass using sae_engine.</span>

<span class="sd">    Args:</span>
<span class="sd">        x: Input tensor of shape [batch_size, n_inputs]</span>

<span class="sd">    Returns:</span>
<span class="sd">        Reconstructed tensor of shape [batch_size, n_inputs]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Overcomplete TopKSAE forward returns (pre_codes, codes, x_reconstructed)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">x_reconstructed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sae_engine</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x_reconstructed</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="mi_crow.mechanistic.sae.modules.topk_sae.TopKSae.load" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">load</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

<a href="#mi_crow.mechanistic.sae.modules.topk_sae.TopKSae.load" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">load</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Load TopKSAE from saved file using overcomplete's load method + our metadata.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>path</code>
            </td>
            <td>
                  <code><span title="pathlib.Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to saved model file</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="&lt;span class=&quot;doc doc-object-name doc-class-name&quot;&gt;mi_crow.mechanistic.sae.modules.topk_sae.TopKSae&lt;/span&gt;" href="#mi_crow.mechanistic.sae.modules.topk_sae.TopKSae">TopKSae</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Loaded TopKSAE instance</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/mi_crow/mechanistic/sae/modules/topk_sae.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;TopKSae&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load TopKSAE from saved file using overcomplete&#39;s load method + our metadata.</span>

<span class="sd">    Args:</span>
<span class="sd">        path: Path to saved model file</span>

<span class="sd">    Returns:</span>
<span class="sd">        Loaded TopKSAE instance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="c1"># Load payload</span>
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
        <span class="n">map_location</span> <span class="o">=</span> <span class="s1">&#39;cuda&#39;</span>
    <span class="k">elif</span> <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">mps</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
        <span class="n">map_location</span> <span class="o">=</span> <span class="s1">&#39;mps&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">map_location</span> <span class="o">=</span> <span class="s1">&#39;cpu&#39;</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="n">map_location</span><span class="p">)</span>

    <span class="c1"># Extract our metadata</span>
    <span class="k">if</span> <span class="s2">&quot;mi_crow_metadata&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid TopKSAE save format: missing &#39;mi_crow_metadata&#39; key in </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">mi_crow_meta</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;mi_crow_metadata&quot;</span><span class="p">]</span>
    <span class="n">n_latents</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mi_crow_meta</span><span class="p">[</span><span class="s2">&quot;n_latents&quot;</span><span class="p">])</span>
    <span class="n">n_inputs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mi_crow_meta</span><span class="p">[</span><span class="s2">&quot;n_inputs&quot;</span><span class="p">])</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mi_crow_meta</span><span class="p">[</span><span class="s2">&quot;k&quot;</span><span class="p">])</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">mi_crow_meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;device&quot;</span><span class="p">,</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
    <span class="n">layer_signature</span> <span class="o">=</span> <span class="n">mi_crow_meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;layer_signature&quot;</span><span class="p">)</span>
    <span class="n">model_id</span> <span class="o">=</span> <span class="n">mi_crow_meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model_id&quot;</span><span class="p">)</span>
    <span class="n">concepts_state</span> <span class="o">=</span> <span class="n">mi_crow_meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;concepts_state&quot;</span><span class="p">,</span> <span class="p">{})</span>

    <span class="c1"># Create TopKSAE instance</span>
    <span class="n">topk_sae</span> <span class="o">=</span> <span class="n">TopKSae</span><span class="p">(</span>
        <span class="n">n_latents</span><span class="o">=</span><span class="n">n_latents</span><span class="p">,</span>
        <span class="n">n_inputs</span><span class="o">=</span><span class="n">n_inputs</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="n">device</span>
    <span class="p">)</span>

    <span class="n">topk_sae</span><span class="o">.</span><span class="n">sae_engine</span> <span class="o">=</span> <span class="n">topk_sae</span><span class="o">.</span><span class="n">_initialize_sae_engine</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>

    <span class="c1"># Load overcomplete model state dict</span>
    <span class="k">if</span> <span class="s2">&quot;sae_state_dict&quot;</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
        <span class="n">topk_sae</span><span class="o">.</span><span class="n">sae_engine</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="s2">&quot;sae_state_dict&quot;</span><span class="p">])</span>
    <span class="k">elif</span> <span class="s2">&quot;model&quot;</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
        <span class="c1"># Backward compatibility with old format</span>
        <span class="n">topk_sae</span><span class="o">.</span><span class="n">sae_engine</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Assume payload is the state dict itself (backward compatibility)</span>
        <span class="n">topk_sae</span><span class="o">.</span><span class="n">sae_engine</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

    <span class="c1"># Load concepts state</span>
    <span class="k">if</span> <span class="n">concepts_state</span><span class="p">:</span>
        <span class="n">device</span> <span class="o">=</span> <span class="n">topk_sae</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">device</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;multiplication&quot;</span> <span class="ow">in</span> <span class="n">concepts_state</span><span class="p">:</span>
            <span class="n">topk_sae</span><span class="o">.</span><span class="n">concepts</span><span class="o">.</span><span class="n">multiplication</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">concepts_state</span><span class="p">[</span><span class="s2">&quot;multiplication&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;bias&quot;</span> <span class="ow">in</span> <span class="n">concepts_state</span><span class="p">:</span>
            <span class="n">topk_sae</span><span class="o">.</span><span class="n">concepts</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">concepts_state</span><span class="p">[</span><span class="s2">&quot;bias&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

    <span class="c1"># Note: Top texts loading was removed as serialization methods were removed</span>
    <span class="c1"># Top texts should be exported/imported separately if needed</span>

    <span class="c1"># Set context metadata</span>
    <span class="n">topk_sae</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">lm_layer_signature</span> <span class="o">=</span> <span class="n">layer_signature</span>
    <span class="n">topk_sae</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">model_id</span> <span class="o">=</span> <span class="n">model_id</span>

    <span class="n">params_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;n_latents=</span><span class="si">{</span><span class="n">n_latents</span><span class="si">}</span><span class="s2">, n_inputs=</span><span class="si">{</span><span class="n">n_inputs</span><span class="si">}</span><span class="s2">, k=</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Loaded TopKSAE from </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">params_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">topk_sae</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="mi_crow.mechanistic.sae.modules.topk_sae.TopKSae.modify_activations" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">modify_activations</span>


<a href="#mi_crow.mechanistic.sae.modules.topk_sae.TopKSae.modify_activations" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">modify_activations</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Modify activations using TopKSAE (Controller hook interface).</p>
<p>Extracts tensor from inputs/output, applies SAE forward pass,
and optionally applies concept manipulation.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>module</code>
            </td>
            <td>
                  <code><span title="torch.nn.Module">Module</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The PyTorch module being hooked</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>inputs</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tuple of inputs to the module</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Output from the module (None for pre_forward hooks)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="torch.Tensor">Tensor</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Modified activations with same shape as input</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/mi_crow/mechanistic/sae/modules/topk_sae.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">modify_activations</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">module</span><span class="p">:</span> <span class="s2">&quot;torch.nn.Module&quot;</span><span class="p">,</span>
        <span class="n">inputs</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">output</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Modify activations using TopKSAE (Controller hook interface).</span>

<span class="sd">    Extracts tensor from inputs/output, applies SAE forward pass,</span>
<span class="sd">    and optionally applies concept manipulation.</span>

<span class="sd">    Args:</span>
<span class="sd">        module: The PyTorch module being hooked</span>
<span class="sd">        inputs: Tuple of inputs to the module</span>
<span class="sd">        output: Output from the module (None for pre_forward hooks)</span>

<span class="sd">    Returns:</span>
<span class="sd">        Modified activations with same shape as input</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Extract tensor from output/inputs, handling objects with last_hidden_state</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hook_type</span> <span class="o">==</span> <span class="n">HookType</span><span class="o">.</span><span class="n">FORWARD</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
            <span class="n">tensor</span> <span class="o">=</span> <span class="n">output</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s2">&quot;last_hidden_state&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">last_hidden_state</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
            <span class="n">tensor</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">last_hidden_state</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
            <span class="c1"># Try to find first tensor in tuple/list</span>
            <span class="n">tensor</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tensor</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tensor</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">tensor</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">output</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hook_type</span> <span class="o">==</span> <span class="n">HookType</span><span class="o">.</span><span class="n">FORWARD</span> <span class="k">else</span> <span class="n">inputs</span>

    <span class="n">original_shape</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1"># Flatten to 2D for SAE processing: (batch, seq_len, hidden) -&gt; (batch * seq_len, hidden)</span>
    <span class="c1"># or keep as 2D if already 2D: (batch, hidden)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">original_shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">batch_size</span><span class="p">,</span> <span class="n">seq_len</span> <span class="o">=</span> <span class="n">original_shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">tensor_flat</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">original_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">original_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">seq_len</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">tensor_flat</span> <span class="o">=</span> <span class="n">tensor</span>

    <span class="c1"># Get full activations (pre_codes) and sparse codes</span>
    <span class="c1"># Overcomplete TopKSAE encode returns (pre_codes, codes)</span>
    <span class="n">pre_codes</span><span class="p">,</span> <span class="n">codes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sae_engine</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">tensor_flat</span><span class="p">)</span>

    <span class="c1"># Save SAE activations (pre_codes) as 3D tensor: (batch, seq, n_latents)</span>
    <span class="n">latents_cpu</span> <span class="o">=</span> <span class="n">pre_codes</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
    <span class="n">latents_3d</span> <span class="o">=</span> <span class="n">latents_cpu</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Save to tensor_metadata</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tensor_metadata</span><span class="p">[</span><span class="s1">&#39;neurons&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">latents_3d</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tensor_metadata</span><span class="p">[</span><span class="s1">&#39;activations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">latents_3d</span>

    <span class="c1"># Process each item in the batch individually for metadata</span>
    <span class="n">batch_items</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">n_items</span> <span class="o">=</span> <span class="n">latents_cpu</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">item_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_items</span><span class="p">):</span>
        <span class="n">item_latents</span> <span class="o">=</span> <span class="n">latents_cpu</span><span class="p">[</span><span class="n">item_idx</span><span class="p">]</span>  <span class="c1"># [n_latents]</span>

        <span class="c1"># Find nonzero indices for this item</span>
        <span class="n">nonzero_mask</span> <span class="o">=</span> <span class="n">item_latents</span> <span class="o">!=</span> <span class="mi">0</span>
        <span class="n">nonzero_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">nonzero_mask</span><span class="p">,</span> <span class="n">as_tuple</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="c1"># Create map of nonzero indices to activations</span>
        <span class="n">activations_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span> <span class="nb">float</span><span class="p">(</span><span class="n">item_latents</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">nonzero_indices</span>
        <span class="p">}</span>

        <span class="c1"># Create item metadata</span>
        <span class="n">item_metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;nonzero_indices&quot;</span><span class="p">:</span> <span class="n">nonzero_indices</span><span class="p">,</span>
            <span class="s2">&quot;activations&quot;</span><span class="p">:</span> <span class="n">activations_map</span>
        <span class="p">}</span>
        <span class="n">batch_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item_metadata</span><span class="p">)</span>

    <span class="c1"># Save batch items metadata</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;batch_items&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">batch_items</span>

    <span class="c1"># Use sparse codes for reconstruction</span>
    <span class="n">latents</span> <span class="o">=</span> <span class="n">codes</span>

    <span class="c1"># Update top texts if text tracking is enabled</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_tracking_enabled</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">lm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">input_tracker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">lm</span><span class="o">.</span><span class="n">get_input_tracker</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">input_tracker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">texts</span> <span class="o">=</span> <span class="n">input_tracker</span><span class="o">.</span><span class="n">get_current_texts</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">texts</span><span class="p">:</span>
                <span class="c1"># Use pre_codes (full activations) for text tracking</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">concepts</span><span class="o">.</span><span class="n">update_top_texts_from_latents</span><span class="p">(</span>
                    <span class="n">latents_cpu</span><span class="p">,</span>
                    <span class="n">texts</span><span class="p">,</span>
                    <span class="n">original_shape</span>
                <span class="p">)</span>

    <span class="c1"># Apply concept manipulation if parameters are set</span>
    <span class="c1"># Check if multiplication or bias differ from defaults (ones)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concepts</span><span class="o">.</span><span class="n">multiplication</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concepts</span><span class="o">.</span><span class="n">multiplication</span><span class="p">))</span> <span class="ow">or</span> \
            <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concepts</span><span class="o">.</span><span class="n">bias</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concepts</span><span class="o">.</span><span class="n">bias</span><span class="p">)):</span>
        <span class="c1"># Apply manipulation: latents = latents * multiplication + bias</span>
        <span class="n">latents</span> <span class="o">=</span> <span class="n">latents</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">concepts</span><span class="o">.</span><span class="n">multiplication</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">concepts</span><span class="o">.</span><span class="n">bias</span>

    <span class="c1"># Decode to get reconstruction</span>
    <span class="n">reconstructed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">latents</span><span class="p">)</span>

    <span class="c1"># Reshape back to original shape</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">original_shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">reconstructed</span> <span class="o">=</span> <span class="n">reconstructed</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">original_shape</span><span class="p">)</span>

    <span class="c1"># Return in appropriate format</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hook_type</span> <span class="o">==</span> <span class="n">HookType</span><span class="o">.</span><span class="n">FORWARD</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">reconstructed</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
            <span class="c1"># Replace first tensor in tuple/list</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">reconstructed</span>
                    <span class="k">break</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="k">else</span> <span class="n">result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># For objects with attributes, try to set last_hidden_state</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s2">&quot;last_hidden_state&quot;</span><span class="p">):</span>
                <span class="n">output</span><span class="o">.</span><span class="n">last_hidden_state</span> <span class="o">=</span> <span class="n">reconstructed</span>
            <span class="k">return</span> <span class="n">output</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># PRE_FORWARD</span>
        <span class="c1"># Return modified inputs tuple</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">reconstructed</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="mi_crow.mechanistic.sae.modules.topk_sae.TopKSae.process_activations" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">process_activations</span>


<a href="#mi_crow.mechanistic.sae.modules.topk_sae.TopKSae.process_activations" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">process_activations</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Process activations (Detector interface).</p>
<p>Metadata saving is handled in modify_activations to avoid duplicate work.
This method is kept for interface compatibility but does nothing since
modify_activations already saves the metadata when called.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>module</code>
            </td>
            <td>
                  <code><span title="torch.nn.Module">Module</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The PyTorch module being hooked</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>input</code>
            </td>
            <td>
                  <code><span title="mi_crow.hooks.hook.HOOK_FUNCTION_INPUT">HOOK_FUNCTION_INPUT</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tuple of input tensors to the module</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output</code>
            </td>
            <td>
                  <code><span title="mi_crow.hooks.hook.HOOK_FUNCTION_OUTPUT">HOOK_FUNCTION_OUTPUT</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Output tensor(s) from the module</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/mi_crow/mechanistic/sae/modules/topk_sae.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">process_activations</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">module</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span>
        <span class="nb">input</span><span class="p">:</span> <span class="n">HOOK_FUNCTION_INPUT</span><span class="p">,</span>
        <span class="n">output</span><span class="p">:</span> <span class="n">HOOK_FUNCTION_OUTPUT</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process activations (Detector interface).</span>

<span class="sd">    Metadata saving is handled in modify_activations to avoid duplicate work.</span>
<span class="sd">    This method is kept for interface compatibility but does nothing since</span>
<span class="sd">    modify_activations already saves the metadata when called.</span>

<span class="sd">    Args:</span>
<span class="sd">        module: The PyTorch module being hooked</span>
<span class="sd">        input: Tuple of input tensors to the module</span>
<span class="sd">        output: Output tensor(s) from the module</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Metadata saving is done in modify_activations to avoid duplicate encoding</span>
    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="mi_crow.mechanistic.sae.modules.topk_sae.TopKSae.save" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">save</span>


<a href="#mi_crow.mechanistic.sae.modules.topk_sae.TopKSae.save" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">save</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Save model using overcomplete's state dict + our metadata.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Model name</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>path</code>
            </td>
            <td>
                  <code><span title="str">str</span> | <span title="pathlib.Path">Path</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Directory path to save to (defaults to current directory)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>k</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Top-K value to save (if None, attempts to get from engine or raises error)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/mi_crow/mechanistic/sae/modules/topk_sae.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save model using overcomplete&#39;s state dict + our metadata.</span>

<span class="sd">    Args:</span>
<span class="sd">        name: Model name</span>
<span class="sd">        path: Directory path to save to (defaults to current directory)</span>
<span class="sd">        k: Top-K value to save (if None, attempts to get from engine or raises error)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span>
    <span class="n">save_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">save_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">save_path</span> <span class="o">=</span> <span class="n">save_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.pt&quot;</span>

    <span class="c1"># Save overcomplete model state dict</span>
    <span class="n">sae_state_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sae_engine</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>

    <span class="c1"># Get k value - prefer parameter, then try to get from engine</span>
    <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sae_engine</span><span class="p">,</span> <span class="s1">&#39;top_k&#39;</span><span class="p">):</span>
            <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sae_engine</span><span class="o">.</span><span class="n">top_k</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;k parameter must be provided to save() method. &quot;</span>
                <span class="s2">&quot;The engine does not expose top_k attribute.&quot;</span>
            <span class="p">)</span>

    <span class="n">mi_crow_metadata</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;concepts_state&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;multiplication&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">concepts</span><span class="o">.</span><span class="n">multiplication</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
            <span class="s1">&#39;bias&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">concepts</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;n_latents&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">n_latents</span><span class="p">,</span>
        <span class="s2">&quot;n_inputs&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">n_inputs</span><span class="p">,</span>
        <span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span>
        <span class="s2">&quot;device&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
        <span class="s2">&quot;layer_signature&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">lm_layer_signature</span><span class="p">,</span>
        <span class="s2">&quot;model_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">model_id</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;sae_state_dict&quot;</span><span class="p">:</span> <span class="n">sae_state_dict</span><span class="p">,</span>
        <span class="s2">&quot;mi_crow_metadata&quot;</span><span class="p">:</span> <span class="n">mi_crow_metadata</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">save_path</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved TopKSAE to </span><span class="si">{</span><span class="n">save_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="mi_crow.mechanistic.sae.modules.topk_sae.TopKSae.train" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">train</span>


<a href="#mi_crow.mechanistic.sae.modules.topk_sae.TopKSae.train" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">train</span><span class="p">(</span><span class="n">store</span><span class="p">,</span> <span class="n">run_id</span><span class="p">,</span> <span class="n">layer_signature</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">training_run_id</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Train TopKSAE using activations from a Store.</p>
<p>This method delegates to the SaeTrainer composite class.
The SAE engine will be reinitialized with the k value from config.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>store</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="&lt;span class=&quot;doc doc-object-name doc-class-name&quot;&gt;Store&lt;/span&gt; (&lt;code&gt;mi_crow.store.store.Store&lt;/code&gt;)" href="../store/#mi_crow.store.Store">Store</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Store instance containing activations</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>run_id</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Run ID to train on</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>config</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="&lt;span class=&quot;doc doc-object-name doc-class-name&quot;&gt;mi_crow.mechanistic.sae.modules.topk_sae.TopKSaeTrainingConfig&lt;/span&gt;


  &lt;span class=&quot;doc doc-labels&quot;&gt;
      &lt;small class=&quot;doc doc-label doc-label-dataclass&quot;&gt;&lt;code&gt;dataclass&lt;/code&gt;&lt;/small&gt;
  &lt;/span&gt;" href="#mi_crow.mechanistic.sae.modules.topk_sae.TopKSaeTrainingConfig">TopKSaeTrainingConfig</a> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Training configuration (must include k parameter)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>training_run_id</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional training run ID</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary with keys:
- "history": Training history dictionary
- "training_run_id": Training run ID where outputs were saved</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If config is None or config.k is not set</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/mi_crow/mechanistic/sae/modules/topk_sae.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">store</span><span class="p">:</span> <span class="n">Store</span><span class="p">,</span>
        <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">layer_signature</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">TopKSaeTrainingConfig</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">training_run_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Train TopKSAE using activations from a Store.</span>

<span class="sd">    This method delegates to the SaeTrainer composite class.</span>
<span class="sd">    The SAE engine will be reinitialized with the k value from config.</span>

<span class="sd">    Args:</span>
<span class="sd">        store: Store instance containing activations</span>
<span class="sd">        run_id: Run ID to train on</span>
<span class="sd">        config: Training configuration (must include k parameter)</span>
<span class="sd">        training_run_id: Optional training run ID</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with keys:</span>
<span class="sd">            - &quot;history&quot;: Training history dictionary</span>
<span class="sd">            - &quot;training_run_id&quot;: Training run ID where outputs were saved</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If config is None or config.k is not set</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">TopKSaeTrainingConfig</span><span class="p">()</span>

    <span class="c1"># Ensure k is set in config</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">config</span><span class="o">.</span><span class="n">k</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;TopKSaeTrainingConfig must have k parameter set. &quot;</span>
            <span class="s2">&quot;Example: TopKSaeTrainingConfig(k=10, epochs=100, ...)&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Reinitialize engine with k from config</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initializing SAE engine with k=</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sae_engine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_sae_engine</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">k</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;device&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">:</span>
        <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sae_engine</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">store</span><span class="p">,</span> <span class="n">run_id</span><span class="p">,</span> <span class="n">layer_signature</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">training_run_id</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="mi_crow.mechanistic.sae.autoencoder_context.AutoencoderContext" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">mi_crow.mechanistic.sae.autoencoder_context.AutoencoderContext</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

<a href="#mi_crow.mechanistic.sae.autoencoder_context.AutoencoderContext" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">AutoencoderContext</span><span class="p">(</span><span class="n">autoencoder</span><span class="p">,</span> <span class="n">n_latents</span><span class="p">,</span> <span class="n">n_inputs</span><span class="p">,</span> <span class="n">lm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lm_layer_signature</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">,</span> <span class="n">experiment_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">run_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">text_tracking_enabled</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">text_tracking_k</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">text_tracking_negative</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tied</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bias_init</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">init_method</span><span class="o">=</span><span class="s1">&#39;kaiming&#39;</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents first">



        <p>Shared context for Autoencoder and its nested components.</p>











<div class="doc doc-children">












  </div>

    </div>

</div><h2 id="training">Training<a class="headerlink" href="#training" title="Permanent link">&para;</a></h2>


<div class="doc doc-object doc-class">



<h2 id="mi_crow.mechanistic.sae.sae_trainer.SaeTrainer" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">mi_crow.mechanistic.sae.sae_trainer.SaeTrainer</span>


<a href="#mi_crow.mechanistic.sae.sae_trainer.SaeTrainer" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">SaeTrainer</span><span class="p">(</span><span class="n">sae</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents first">



        <p>Composite trainer class for SAE models using overcomplete's training functions.</p>
<p>This trainer handles training of any SAE that has a sae_engine attribute
compatible with overcomplete's train_sae functions.</p>

        <p>Initialize SaeTrainer.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>sae</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="&lt;span class=&quot;doc doc-object-name doc-class-name&quot;&gt;mi_crow.mechanistic.sae.sae.Sae&lt;/span&gt;" href="#mi_crow.mechanistic.sae.sae.Sae">Sae</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The SAE instance to train</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>








                  <details class="mkdocstrings-source">
                    <summary>Source code in <code>src/mi_crow/mechanistic/sae/sae_trainer.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sae</span><span class="p">:</span> <span class="s2">&quot;Sae&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize SaeTrainer.</span>

<span class="sd">    Args:</span>
<span class="sd">        sae: The SAE instance to train</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sae</span> <span class="o">=</span> <span class="n">sae</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
                  </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="mi_crow.mechanistic.sae.sae_trainer.SaeTrainingConfig" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">mi_crow.mechanistic.sae.sae_trainer.SaeTrainingConfig</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

<a href="#mi_crow.mechanistic.sae.sae_trainer.SaeTrainingConfig" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">SaeTrainingConfig</span><span class="p">(</span><span class="n">epochs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">l1_lambda</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_batches_per_epoch</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_amp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">amp_dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">grad_accum_steps</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">clip_grad</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">monitoring</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">scheduler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_nan_fallbacks</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">use_wandb</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">wandb_project</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wandb_entity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wandb_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wandb_tags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wandb_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wandb_mode</span><span class="o">=</span><span class="s1">&#39;online&#39;</span><span class="p">,</span> <span class="n">wandb_slow_metrics_frequency</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">wandb_api_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">memory_efficient</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">snapshot_every_n_epochs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">snapshot_base_path</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents first">



        <p>Configuration for SAE training (compatible with overcomplete.train_sae).</p>











<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="mi_crow.mechanistic.sae.modules.topk_sae.TopKSaeTrainingConfig" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">mi_crow.mechanistic.sae.modules.topk_sae.TopKSaeTrainingConfig</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

<a href="#mi_crow.mechanistic.sae.modules.topk_sae.TopKSaeTrainingConfig" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">TopKSaeTrainingConfig</span><span class="p">(</span><span class="n">epochs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">l1_lambda</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_batches_per_epoch</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_amp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">amp_dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">grad_accum_steps</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">clip_grad</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">monitoring</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">scheduler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_nan_fallbacks</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">use_wandb</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">wandb_project</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wandb_entity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wandb_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wandb_tags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wandb_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wandb_mode</span><span class="o">=</span><span class="s1">&#39;online&#39;</span><span class="p">,</span> <span class="n">wandb_slow_metrics_frequency</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">wandb_api_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">memory_efficient</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">snapshot_every_n_epochs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">snapshot_base_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="&lt;span class=&quot;doc doc-object-name doc-class-name&quot;&gt;mi_crow.mechanistic.sae.sae_trainer.SaeTrainingConfig&lt;/span&gt;


  &lt;span class=&quot;doc doc-labels&quot;&gt;
      &lt;small class=&quot;doc doc-label doc-label-dataclass&quot;&gt;&lt;code&gt;dataclass&lt;/code&gt;&lt;/small&gt;
  &lt;/span&gt;" href="#mi_crow.mechanistic.sae.sae_trainer.SaeTrainingConfig">SaeTrainingConfig</a></code></p>



        <p>Training configuration for TopK SAE models.</p>
<p>This class extends SaeTrainingConfig to provide a type-safe configuration
interface specifically for TopK SAE models. It adds the <code>k</code> parameter which
specifies how many top activations to keep during encoding.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>k</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of top activations to keep (required for TopK SAE training)</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Note</summary>
  <p>All other parameters are inherited from SaeTrainingConfig.</p>
</details>

<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="mi_crow.mechanistic.sae.modules.topk_sae.TopKSaeTrainingConfig.k">k</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of top activations to keep during TopK encoding</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>config = TopKSaeTrainingConfig(
...     k=10,
...     epochs=100,
...     batch_size=1024,
...     lr=1e-3,
...     l1_lambda=1e-4
... )</p>
</blockquote>
</blockquote>
</blockquote>
</details>










<div class="doc doc-children">












  </div>

    </div>

</div><h2 id="concepts">Concepts<a class="headerlink" href="#concepts" title="Permanent link">&para;</a></h2>


<div class="doc doc-object doc-class">



<h2 id="mi_crow.mechanistic.sae.concepts.autoencoder_concepts.AutoencoderConcepts" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">mi_crow.mechanistic.sae.concepts.autoencoder_concepts.AutoencoderConcepts</span>


<a href="#mi_crow.mechanistic.sae.concepts.autoencoder_concepts.AutoencoderConcepts" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">AutoencoderConcepts</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents first">










                  <details class="mkdocstrings-source">
                    <summary>Source code in <code>src/mi_crow/mechanistic/sae/concepts/autoencoder_concepts.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">context</span><span class="p">:</span> <span class="n">AutoencoderContext</span>
<span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">context</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_n_size</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">n_latents</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="p">:</span> <span class="n">ConceptDictionary</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">multiplication</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_size</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bias</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_size</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_text_heaps_positive</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TextHeap</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_text_heaps_negative</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TextHeap</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_text_tracking_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_text_tracking_negative</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
                  </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="mi_crow.mechanistic.sae.concepts.autoencoder_concepts.AutoencoderConcepts.enable_text_tracking" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">enable_text_tracking</span>


<a href="#mi_crow.mechanistic.sae.concepts.autoencoder_concepts.AutoencoderConcepts.enable_text_tracking" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">enable_text_tracking</span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Enable text tracking using context parameters.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/mi_crow/mechanistic/sae/concepts/autoencoder_concepts.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">enable_text_tracking</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Enable text tracking using context parameters.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">lm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;LanguageModel must be set in context to enable tracking&quot;</span><span class="p">)</span>

    <span class="c1"># Store tracking parameters</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_text_tracking_k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">text_tracking_k</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_text_tracking_negative</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">text_tracking_negative</span>

    <span class="c1"># Ensure InputTracker singleton exists on LanguageModel and enable it</span>
    <span class="n">input_tracker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">lm</span><span class="o">.</span><span class="n">_ensure_input_tracker</span><span class="p">()</span>
    <span class="n">input_tracker</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>

    <span class="c1"># Enable text tracking on the SAE instance</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">autoencoder</span><span class="p">,</span> <span class="s1">&#39;_text_tracking_enabled&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">autoencoder</span><span class="o">.</span><span class="n">_text_tracking_enabled</span> <span class="o">=</span> <span class="kc">True</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="mi_crow.mechanistic.sae.concepts.autoencoder_concepts.AutoencoderConcepts.export_bottom_texts_to_json" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">export_bottom_texts_to_json</span>


<a href="#mi_crow.mechanistic.sae.concepts.autoencoder_concepts.AutoencoderConcepts.export_bottom_texts_to_json" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">export_bottom_texts_to_json</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Export bottom texts (negative activations) to JSON file.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/mi_crow/mechanistic/sae/concepts/autoencoder_concepts.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">export_bottom_texts_to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Export bottom texts (negative activations) to JSON file.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_tracking_negative</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_heaps_negative</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No bottom texts available. Enable negative text tracking and run inference first.&quot;</span><span class="p">)</span>

    <span class="n">filepath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="n">filepath</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">all_texts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_bottom_texts</span><span class="p">()</span>
    <span class="n">export_data</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">neuron_idx</span><span class="p">,</span> <span class="n">neuron_texts</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_texts</span><span class="p">):</span>
        <span class="n">export_data</span><span class="p">[</span><span class="n">neuron_idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">nt</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
                <span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="n">nt</span><span class="o">.</span><span class="n">score</span><span class="p">,</span>
                <span class="s2">&quot;token_str&quot;</span><span class="p">:</span> <span class="n">nt</span><span class="o">.</span><span class="n">token_str</span><span class="p">,</span>
                <span class="s2">&quot;token_idx&quot;</span><span class="p">:</span> <span class="n">nt</span><span class="o">.</span><span class="n">token_idx</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">nt</span> <span class="ow">in</span> <span class="n">neuron_texts</span>
        <span class="p">]</span>

    <span class="k">with</span> <span class="n">filepath</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">export_data</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">filepath</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="mi_crow.mechanistic.sae.concepts.autoencoder_concepts.AutoencoderConcepts.export_top_texts_to_json" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">export_top_texts_to_json</span>


<a href="#mi_crow.mechanistic.sae.concepts.autoencoder_concepts.AutoencoderConcepts.export_top_texts_to_json" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">export_top_texts_to_json</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Export top texts (positive activations) to JSON file.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/mi_crow/mechanistic/sae/concepts/autoencoder_concepts.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">export_top_texts_to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Export top texts (positive activations) to JSON file.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_heaps_positive</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No top texts available. Enable text tracking and run inference first.&quot;</span><span class="p">)</span>

    <span class="n">filepath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="n">filepath</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">all_texts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_top_texts</span><span class="p">()</span>
    <span class="n">export_data</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">neuron_idx</span><span class="p">,</span> <span class="n">neuron_texts</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_texts</span><span class="p">):</span>
        <span class="n">export_data</span><span class="p">[</span><span class="n">neuron_idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">nt</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
                <span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="n">nt</span><span class="o">.</span><span class="n">score</span><span class="p">,</span>
                <span class="s2">&quot;token_str&quot;</span><span class="p">:</span> <span class="n">nt</span><span class="o">.</span><span class="n">token_str</span><span class="p">,</span>
                <span class="s2">&quot;token_idx&quot;</span><span class="p">:</span> <span class="n">nt</span><span class="o">.</span><span class="n">token_idx</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">nt</span> <span class="ow">in</span> <span class="n">neuron_texts</span>
        <span class="p">]</span>

    <span class="k">with</span> <span class="n">filepath</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">export_data</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">filepath</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="mi_crow.mechanistic.sae.concepts.autoencoder_concepts.AutoencoderConcepts.generate_concepts_with_llm" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">generate_concepts_with_llm</span>


<a href="#mi_crow.mechanistic.sae.concepts.autoencoder_concepts.AutoencoderConcepts.generate_concepts_with_llm" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">generate_concepts_with_llm</span><span class="p">(</span><span class="n">llm_provider</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Generate concepts using LLM based on current top texts</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/mi_crow/mechanistic/sae/concepts/autoencoder_concepts.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">generate_concepts_with_llm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">llm_provider</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate concepts using LLM based on current top texts&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_heaps_positive</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No top texts available. Enable text tracking and run inference first.&quot;</span><span class="p">)</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">mi_crow.mechanistic.sae.concepts.concept_dictionary</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConceptDictionary</span>
    <span class="n">neuron_texts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_top_texts</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span> <span class="o">=</span> <span class="n">ConceptDictionary</span><span class="o">.</span><span class="n">from_llm</span><span class="p">(</span>
        <span class="n">neuron_texts</span><span class="o">=</span><span class="n">neuron_texts</span><span class="p">,</span>
        <span class="n">n_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_size</span><span class="p">,</span>
        <span class="n">store</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">store</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">llm_provider</span><span class="o">=</span><span class="n">llm_provider</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="mi_crow.mechanistic.sae.concepts.autoencoder_concepts.AutoencoderConcepts.get_all_bottom_texts" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">get_all_bottom_texts</span>


<a href="#mi_crow.mechanistic.sae.concepts.autoencoder_concepts.AutoencoderConcepts.get_all_bottom_texts" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">get_all_bottom_texts</span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Get bottom texts for all neurons (negative activations).</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/mi_crow/mechanistic/sae/concepts/autoencoder_concepts.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_all_bottom_texts</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">NeuronText</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get bottom texts for all neurons (negative activations).&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_tracking_negative</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_heaps_negative</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_bottom_texts_for_neuron</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_text_heaps_negative</span><span class="p">))]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="mi_crow.mechanistic.sae.concepts.autoencoder_concepts.AutoencoderConcepts.get_all_top_texts" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">get_all_top_texts</span>


<a href="#mi_crow.mechanistic.sae.concepts.autoencoder_concepts.AutoencoderConcepts.get_all_top_texts" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">get_all_top_texts</span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Get top texts for all neurons (positive activations).</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/mi_crow/mechanistic/sae/concepts/autoencoder_concepts.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_all_top_texts</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">NeuronText</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get top texts for all neurons (positive activations).&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_heaps_positive</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_top_texts_for_neuron</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_text_heaps_positive</span><span class="p">))]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="mi_crow.mechanistic.sae.concepts.autoencoder_concepts.AutoencoderConcepts.get_bottom_texts_for_neuron" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">get_bottom_texts_for_neuron</span>


<a href="#mi_crow.mechanistic.sae.concepts.autoencoder_concepts.AutoencoderConcepts.get_bottom_texts_for_neuron" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">get_bottom_texts_for_neuron</span><span class="p">(</span><span class="n">neuron_idx</span><span class="p">,</span> <span class="n">top_m</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Get bottom texts for a specific neuron (negative activations).</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/mi_crow/mechanistic/sae/concepts/autoencoder_concepts.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_bottom_texts_for_neuron</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">neuron_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">top_m</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">NeuronText</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get bottom texts for a specific neuron (negative activations).&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_tracking_negative</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_heaps_negative</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">neuron_idx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">neuron_idx</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_text_heaps_negative</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="n">heap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_heaps_negative</span><span class="p">[</span><span class="n">neuron_idx</span><span class="p">]</span>
    <span class="n">items</span> <span class="o">=</span> <span class="n">heap</span><span class="o">.</span><span class="n">get_items</span><span class="p">()</span>
    <span class="n">items_sorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s_t</span><span class="p">:</span> <span class="n">s_t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">top_m</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">items_sorted</span> <span class="o">=</span> <span class="n">items_sorted</span><span class="p">[:</span> <span class="n">top_m</span><span class="p">]</span>

    <span class="n">neuron_texts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">score</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">token_idx</span> <span class="ow">in</span> <span class="n">items_sorted</span><span class="p">:</span>
        <span class="n">token_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decode_token</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">token_idx</span><span class="p">)</span>
        <span class="n">neuron_texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NeuronText</span><span class="p">(</span><span class="n">score</span><span class="o">=</span><span class="n">score</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">,</span> <span class="n">token_idx</span><span class="o">=</span><span class="n">token_idx</span><span class="p">,</span> <span class="n">token_str</span><span class="o">=</span><span class="n">token_str</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">neuron_texts</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="mi_crow.mechanistic.sae.concepts.autoencoder_concepts.AutoencoderConcepts.get_top_texts_for_neuron" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">get_top_texts_for_neuron</span>


<a href="#mi_crow.mechanistic.sae.concepts.autoencoder_concepts.AutoencoderConcepts.get_top_texts_for_neuron" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">get_top_texts_for_neuron</span><span class="p">(</span><span class="n">neuron_idx</span><span class="p">,</span> <span class="n">top_m</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Get top texts for a specific neuron (positive activations).</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/mi_crow/mechanistic/sae/concepts/autoencoder_concepts.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_top_texts_for_neuron</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">neuron_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">top_m</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">NeuronText</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get top texts for a specific neuron (positive activations).&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_heaps_positive</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">neuron_idx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">neuron_idx</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_text_heaps_positive</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="n">heap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_heaps_positive</span><span class="p">[</span><span class="n">neuron_idx</span><span class="p">]</span>
    <span class="n">items</span> <span class="o">=</span> <span class="n">heap</span><span class="o">.</span><span class="n">get_items</span><span class="p">()</span>
    <span class="n">items_sorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s_t</span><span class="p">:</span> <span class="n">s_t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">top_m</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">items_sorted</span> <span class="o">=</span> <span class="n">items_sorted</span><span class="p">[:</span> <span class="n">top_m</span><span class="p">]</span>

    <span class="n">neuron_texts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">score</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">token_idx</span> <span class="ow">in</span> <span class="n">items_sorted</span><span class="p">:</span>
        <span class="n">token_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decode_token</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">token_idx</span><span class="p">)</span>
        <span class="n">neuron_texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NeuronText</span><span class="p">(</span><span class="n">score</span><span class="o">=</span><span class="n">score</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">,</span> <span class="n">token_idx</span><span class="o">=</span><span class="n">token_idx</span><span class="p">,</span> <span class="n">token_str</span><span class="o">=</span><span class="n">token_str</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">neuron_texts</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="mi_crow.mechanistic.sae.concepts.autoencoder_concepts.AutoencoderConcepts.reset_top_texts" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">reset_top_texts</span>


<a href="#mi_crow.mechanistic.sae.concepts.autoencoder_concepts.AutoencoderConcepts.reset_top_texts" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">reset_top_texts</span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Reset all tracked top texts.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/mi_crow/mechanistic/sae/concepts/autoencoder_concepts.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">reset_top_texts</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reset all tracked top texts.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_text_heaps_positive</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_text_heaps_negative</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="mi_crow.mechanistic.sae.concepts.autoencoder_concepts.AutoencoderConcepts.update_top_texts_from_latents" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">update_top_texts_from_latents</span>


<a href="#mi_crow.mechanistic.sae.concepts.autoencoder_concepts.AutoencoderConcepts.update_top_texts_from_latents" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">update_top_texts_from_latents</span><span class="p">(</span><span class="n">latents</span><span class="p">,</span> <span class="n">texts</span><span class="p">,</span> <span class="n">original_shape</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Update top texts heaps from latents and texts.</p>
<p>Optimized version that:
- Only processes active neurons (non-zero activations)
- Vectorizes argmax/argmin operations
- Eliminates per-neuron tensor slicing</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>latents</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Latent activations tensor, shape [B*T, n_latents] or [B, n_latents] (already flattened)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>texts</code>
            </td>
            <td>
                  <code><span title="typing.Sequence">Sequence</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of texts corresponding to the batch</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>original_shape</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span>[<span title="int">int</span>, ...] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Original shape before flattening, e.g., (B, T, D) or (B, D)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/mi_crow/mechanistic/sae/concepts/autoencoder_concepts.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">update_top_texts_from_latents</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">latents</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">texts</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">original_shape</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update top texts heaps from latents and texts.</span>

<span class="sd">    Optimized version that:</span>
<span class="sd">    - Only processes active neurons (non-zero activations)</span>
<span class="sd">    - Vectorizes argmax/argmin operations</span>
<span class="sd">    - Eliminates per-neuron tensor slicing</span>

<span class="sd">    Args:</span>
<span class="sd">        latents: Latent activations tensor, shape [B*T, n_latents] or [B, n_latents] (already flattened)</span>
<span class="sd">        texts: List of texts corresponding to the batch</span>
<span class="sd">        original_shape: Original shape before flattening, e.g., (B, T, D) or (B, D)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">texts</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">n_neurons</span> <span class="o">=</span> <span class="n">latents</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_heaps</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">)</span>

    <span class="c1"># Calculate batch and token dimensions</span>
    <span class="n">original_B</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span>
    <span class="n">BT</span> <span class="o">=</span> <span class="n">latents</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Total positions (B*T if 3D original, or B if 2D original)</span>

    <span class="c1"># Determine if original was 3D or 2D</span>
    <span class="k">if</span> <span class="n">original_shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">original_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="c1"># Original was [B, T, D], latents are [B*T, n_latents]</span>
        <span class="n">B</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">original_shape</span>
        <span class="c1"># Verify batch size matches</span>
        <span class="k">if</span> <span class="n">B</span> <span class="o">!=</span> <span class="n">original_B</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Batch size mismatch: original_shape has B=</span><span class="si">{</span><span class="n">B</span><span class="si">}</span><span class="s2">, but </span><span class="si">{</span><span class="n">original_B</span><span class="si">}</span><span class="s2"> texts provided&quot;</span><span class="p">)</span>
            <span class="c1"># Use the actual number of texts as batch size</span>
            <span class="n">B</span> <span class="o">=</span> <span class="n">original_B</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">BT</span> <span class="o">//</span> <span class="n">B</span> <span class="k">if</span> <span class="n">B</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Original was [B, D], latents are [B, n_latents]</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">original_B</span>
        <span class="n">T</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># OPTIMIZATION 1: Find active neurons (have any non-zero activation across batch)</span>
    <span class="c1"># Shape: [n_neurons] - boolean mask</span>
    <span class="n">active_neurons_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">latents</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">active_neuron_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">active_neurons_mask</span><span class="p">,</span> <span class="n">as_tuple</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">active_neuron_indices</span><span class="p">:</span>
        <span class="k">return</span>  <span class="c1"># No active neurons, skip</span>

    <span class="c1"># OPTIMIZATION 2: Vectorize argmax/argmin for all neurons at once</span>
    <span class="k">if</span> <span class="n">original_shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">original_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="c1"># Reshape to [B, T, n_neurons]</span>
        <span class="n">latents_3d</span> <span class="o">=</span> <span class="n">latents</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">n_neurons</span><span class="p">)</span>
        <span class="c1"># For each text, find max/min across tokens for each neuron</span>
        <span class="c1"># Shape: [B, n_neurons] - max activation per text per neuron</span>
        <span class="n">max_activations</span><span class="p">,</span> <span class="n">max_token_indices_3d</span> <span class="o">=</span> <span class="n">latents_3d</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># [B, n_neurons]</span>
        <span class="n">min_activations</span><span class="p">,</span> <span class="n">min_token_indices_3d</span> <span class="o">=</span> <span class="n">latents_3d</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># [B, n_neurons]</span>
        <span class="c1"># max_token_indices_3d is already the token index (0 to T-1)</span>
        <span class="n">max_token_indices</span> <span class="o">=</span> <span class="n">max_token_indices_3d</span>
        <span class="n">min_token_indices</span> <span class="o">=</span> <span class="n">min_token_indices_3d</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Shape: [B, n_neurons]</span>
        <span class="n">latents_2d</span> <span class="o">=</span> <span class="n">latents</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">n_neurons</span><span class="p">)</span>
        <span class="n">max_activations</span> <span class="o">=</span> <span class="n">latents_2d</span>  <span class="c1"># [B, n_neurons]</span>
        <span class="n">max_token_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">n_neurons</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">latents</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">min_activations</span> <span class="o">=</span> <span class="n">latents_2d</span>
        <span class="n">min_token_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">n_neurons</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">latents</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

    <span class="c1"># Convert to numpy for faster CPU access (already on CPU from l1_sae.py)</span>
    <span class="n">max_activations_np</span> <span class="o">=</span> <span class="n">max_activations</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="n">min_activations_np</span> <span class="o">=</span> <span class="n">min_activations</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="n">max_token_indices_np</span> <span class="o">=</span> <span class="n">max_token_indices</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="n">min_token_indices_np</span> <span class="o">=</span> <span class="n">min_token_indices</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

    <span class="c1"># OPTIMIZATION 3: Only process active neurons</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">active_neuron_indices</span><span class="p">:</span>
        <span class="n">heap_positive</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_heaps_positive</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">heap_negative</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_heaps_negative</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_tracking_negative</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="c1"># OPTIMIZATION 4: Batch process all texts for this neuron</span>
        <span class="k">for</span> <span class="n">batch_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">original_B</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">batch_idx</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">texts</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">text</span> <span class="o">=</span> <span class="n">texts</span><span class="p">[</span><span class="n">batch_idx</span><span class="p">]</span>

            <span class="c1"># Use pre-computed max/min (no tensor slicing needed!)</span>
            <span class="n">max_score_positive</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">max_activations_np</span><span class="p">[</span><span class="n">batch_idx</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
            <span class="n">token_idx_positive</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_token_indices_np</span><span class="p">[</span><span class="n">batch_idx</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">max_score_positive</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">heap_positive</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">max_score_positive</span><span class="p">,</span> <span class="n">token_idx_positive</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_tracking_negative</span> <span class="ow">and</span> <span class="n">heap_negative</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">min_score_negative</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">min_activations_np</span><span class="p">[</span><span class="n">batch_idx</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">min_score_negative</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">token_idx_negative</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">min_token_indices_np</span><span class="p">[</span><span class="n">batch_idx</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
                    <span class="n">heap_negative</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">min_score_negative</span><span class="p">,</span> <span class="n">token_idx_negative</span><span class="p">,</span> <span class="n">adjusted_score</span><span class="o">=-</span><span class="n">min_score_negative</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="mi_crow.mechanistic.sae.concepts.concept_dictionary.ConceptDictionary" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">mi_crow.mechanistic.sae.concepts.concept_dictionary.ConceptDictionary</span>


<a href="#mi_crow.mechanistic.sae.concepts.concept_dictionary.ConceptDictionary" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">ConceptDictionary</span><span class="p">(</span><span class="n">n_size</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents first">










                  <details class="mkdocstrings-source">
                    <summary>Source code in <code>src/mi_crow/mechanistic/sae/concepts/concept_dictionary.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">n_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">store</span><span class="p">:</span> <span class="n">Store</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">n_size</span> <span class="o">=</span> <span class="n">n_size</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">concepts_map</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Concept</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">store</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_directory</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
                  </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="mi_crow.mechanistic.sae.concepts.concept_models" class="doc doc-heading">
            <span class="doc doc-object-name doc-module-name">mi_crow.mechanistic.sae.concepts.concept_models</span>


<a href="#mi_crow.mechanistic.sae.concepts.concept_models" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents first">










<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="mi_crow.mechanistic.sae.concepts.input_tracker.InputTracker" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">mi_crow.mechanistic.sae.concepts.input_tracker.InputTracker</span>


<a href="#mi_crow.mechanistic.sae.concepts.input_tracker.InputTracker" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">InputTracker</span><span class="p">(</span><span class="n">language_model</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents first">



        <p>Simple listener that saves input texts before tokenization.</p>
<p>This is a singleton per LanguageModel instance. It's used as a listener
during inference to capture texts before they are tokenized. SAE hooks
can then access these texts to track top activating texts for their neurons.</p>

        <p>Initialize InputTracker.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>language_model</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="&lt;span class=&quot;doc doc-object-name doc-class-name&quot;&gt;mi_crow.language_model.language_model.LanguageModel&lt;/span&gt;" href="../language_model/#mi_crow.language_model.language_model.LanguageModel">LanguageModel</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Language model instance</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>








                  <details class="mkdocstrings-source">
                    <summary>Source code in <code>src/mi_crow/mechanistic/sae/concepts/input_tracker.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">language_model</span><span class="p">:</span> <span class="s2">&quot;LanguageModel&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize InputTracker.</span>

<span class="sd">    Args:</span>
<span class="sd">        language_model: Language model instance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">language_model</span> <span class="o">=</span> <span class="n">language_model</span>

    <span class="c1"># Flag to control whether to save inputs</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Runtime state - only stores texts</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_current_texts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</code></pre></div></td></tr></table></div>
                  </details>



<div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="mi_crow.mechanistic.sae.concepts.input_tracker.InputTracker.enabled" class="doc doc-heading">
            <span class="doc doc-object-name doc-attribute-name">enabled</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

<a href="#mi_crow.mechanistic.sae.concepts.input_tracker.InputTracker.enabled" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">enabled</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Whether input tracking is enabled.</p>

    </div>

</div>




<div class="doc doc-object doc-function">


<h3 id="mi_crow.mechanistic.sae.concepts.input_tracker.InputTracker.disable" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">disable</span>


<a href="#mi_crow.mechanistic.sae.concepts.input_tracker.InputTracker.disable" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">disable</span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Disable input tracking.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/mi_crow/mechanistic/sae/concepts/input_tracker.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">disable</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Disable input tracking.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_enabled</span> <span class="o">=</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="mi_crow.mechanistic.sae.concepts.input_tracker.InputTracker.enable" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">enable</span>


<a href="#mi_crow.mechanistic.sae.concepts.input_tracker.InputTracker.enable" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">enable</span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Enable input tracking.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/mi_crow/mechanistic/sae/concepts/input_tracker.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">enable</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Enable input tracking.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_enabled</span> <span class="o">=</span> <span class="kc">True</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="mi_crow.mechanistic.sae.concepts.input_tracker.InputTracker.get_current_texts" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">get_current_texts</span>


<a href="#mi_crow.mechanistic.sae.concepts.input_tracker.InputTracker.get_current_texts" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">get_current_texts</span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Get the current batch of texts.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/mi_crow/mechanistic/sae/concepts/input_tracker.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_current_texts</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the current batch of texts.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_texts</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="mi_crow.mechanistic.sae.concepts.input_tracker.InputTracker.reset" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">reset</span>


<a href="#mi_crow.mechanistic.sae.concepts.input_tracker.InputTracker.reset" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">reset</span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Reset stored texts.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/mi_crow/mechanistic/sae/concepts/input_tracker.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reset stored texts.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_current_texts</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="mi_crow.mechanistic.sae.concepts.input_tracker.InputTracker.set_current_texts" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">set_current_texts</span>


<a href="#mi_crow.mechanistic.sae.concepts.input_tracker.InputTracker.set_current_texts" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">set_current_texts</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Set the current batch of texts being processed.</p>
<p>This is called by LanguageModel._inference() before tokenization
if tracking is enabled.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/mi_crow/mechanistic/sae/concepts/input_tracker.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_current_texts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">texts</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set the current batch of texts being processed.</span>

<span class="sd">    This is called by LanguageModel._inference() before tokenization</span>
<span class="sd">    if tracking is enabled.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enabled</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_texts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><h2 id="training-utilities">Training Utilities<a class="headerlink" href="#training-utilities" title="Permanent link">&para;</a></h2>


<div class="doc doc-object doc-class">



<h2 id="mi_crow.mechanistic.sae.training.wandb_logger.WandbLogger" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">mi_crow.mechanistic.sae.training.wandb_logger.WandbLogger</span>


<a href="#mi_crow.mechanistic.sae.training.wandb_logger.WandbLogger" class="headerlink" title="Permanent link">&para;</a></h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">WandbLogger</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">run_id</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents first">



        <p>Handles wandb logging for SAE training.</p>
<p>Encapsulates all wandb-related operations including initialization,
metric logging, and summary updates.</p>

        <p>Initialize WandbLogger.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>config</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="&lt;span class=&quot;doc doc-object-name doc-class-name&quot;&gt;mi_crow.mechanistic.sae.sae_trainer.SaeTrainingConfig&lt;/span&gt;


  &lt;span class=&quot;doc doc-labels&quot;&gt;
      &lt;small class=&quot;doc doc-label doc-label-dataclass&quot;&gt;&lt;code&gt;dataclass&lt;/code&gt;&lt;/small&gt;
  &lt;/span&gt;" href="#mi_crow.mechanistic.sae.sae_trainer.SaeTrainingConfig">SaeTrainingConfig</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Training configuration</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>run_id</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Training run identifier</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>








                  <details class="mkdocstrings-source">
                    <summary>Source code in <code>src/mi_crow/mechanistic/sae/training/wandb_logger.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">SaeTrainingConfig</span><span class="p">,</span> <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize WandbLogger.</span>

<span class="sd">    Args:</span>
<span class="sd">        config: Training configuration</span>
<span class="sd">        run_id: Training run identifier</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">run_id</span> <span class="o">=</span> <span class="n">run_id</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">wandb_run</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span> <span class="o">=</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
                  </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="mi_crow.mechanistic.sae.training.wandb_logger.WandbLogger.initialize" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">initialize</span>


<a href="#mi_crow.mechanistic.sae.training.wandb_logger.WandbLogger.initialize" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">initialize</span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Initialize wandb run if enabled in config.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True if wandb was successfully initialized, False otherwise</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/mi_crow/mechanistic/sae/training/wandb_logger.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize wandb run if enabled in config.</span>

<span class="sd">    Returns:</span>
<span class="sd">        True if wandb was successfully initialized, False otherwise</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">use_wandb</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">wandb</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;[WandbLogger] wandb not installed, skipping wandb logging&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;[WandbLogger] Install with: pip install wandb&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">wandb_project</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">wandb_project</span> <span class="ow">or</span> <span class="s2">&quot;sae-training&quot;</span>
        <span class="n">wandb_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">wandb_name</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_id</span>
        <span class="n">wandb_mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">wandb_mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">wandb_mode</span> <span class="k">else</span> <span class="s2">&quot;online&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wandb_run</span> <span class="o">=</span> <span class="n">wandb</span><span class="o">.</span><span class="n">init</span><span class="p">(</span>
            <span class="n">project</span><span class="o">=</span><span class="n">wandb_project</span><span class="p">,</span>
            <span class="n">entity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">wandb_entity</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">wandb_name</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="n">wandb_mode</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_build_wandb_config</span><span class="p">(),</span>
            <span class="n">tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">wandb_tags</span> <span class="ow">or</span> <span class="p">[],</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[WandbLogger] Unexpected error initializing wandb: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;[WandbLogger] Continuing training without wandb logging&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="mi_crow.mechanistic.sae.training.wandb_logger.WandbLogger.log_metrics" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">log_metrics</span>


<a href="#mi_crow.mechanistic.sae.training.wandb_logger.WandbLogger.log_metrics" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">log_metrics</span><span class="p">(</span><span class="n">history</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Log training metrics to wandb.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>history</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="list">list</span>[<span title="float">float</span> | None]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary with training history (loss, r2, l1, l0, etc.)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>verbose</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to log verbose information</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/mi_crow/mechanistic/sae/training/wandb_logger.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">log_metrics</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">history</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]],</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Log training metrics to wandb.</span>

<span class="sd">    Args:</span>
<span class="sd">        history: Dictionary with training history (loss, r2, l1, l0, etc.)</span>
<span class="sd">        verbose: Whether to log verbose information</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">wandb_run</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">num_epochs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;loss&quot;</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="n">slow_metrics_freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">wandb_slow_metrics_frequency</span>

        <span class="c1"># Helper to get last known value for slow metrics</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">get_last_known_value</span><span class="p">(</span><span class="n">values</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span><span class="p">],</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Get the last non-None value up to idx, or 0.0 if none found.&quot;&quot;&quot;</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="ow">and</span> <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">return</span> <span class="mf">0.0</span>

        <span class="c1"># Log metrics for each epoch</span>
        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_epochs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">epoch_idx</span> <span class="o">=</span> <span class="n">epoch</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">should_log_slow</span> <span class="o">=</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">%</span> <span class="n">slow_metrics_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">==</span> <span class="n">num_epochs</span><span class="p">)</span>

            <span class="n">metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_epoch_metrics</span><span class="p">(</span><span class="n">history</span><span class="p">,</span> <span class="n">epoch_idx</span><span class="p">,</span> <span class="n">should_log_slow</span><span class="p">,</span> <span class="n">get_last_known_value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wandb_run</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>

        <span class="c1"># Log final summary metrics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_summary_metrics</span><span class="p">(</span><span class="n">history</span><span class="p">,</span> <span class="n">get_last_known_value</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_wandb_url</span><span class="p">()</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[WandbLogger] Failed to log metrics to wandb: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.instant", "navigation.tracking", "navigation.tabs", "content.code.copy", "content.action.edit", "content.tabs.link", "content.tooltips"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>